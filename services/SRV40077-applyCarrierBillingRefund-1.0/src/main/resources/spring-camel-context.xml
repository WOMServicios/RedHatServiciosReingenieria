<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans 
    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd 
    http://camel.apache.org/schema/spring 
    http://camel.apache.org/schema/spring/camel-spring.xsd">

	<import resource="bean-definitions.xml" />

	<camelContext
		xmlns="http://camel.apache.org/schema/spring"
		xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
		xmlns:ns="http://ws.wom.cl/wom/neg/billingaccountmanagement/applycarrierbillingrefund/v/1">

		<propertyPlaceholder id="placeholder"
			location="classpath:sql.properties ,file:${env:APP_ENV}" />

		<onException>
			<exception>cl.wom.exception.services.ServiceError</exception>
			<handled>
				<constant>true</constant>
			</handled>
			<setHeader headerName="codigoError">
				<simple>${exception.codigoError}</simple>
			</setHeader>
			<setHeader headerName="messageError">
				<simple>${exception.message}</simple>
			</setHeader>
			<setHeader headerName="Content-Type">
				<constant>application/json</constant>
			</setHeader>
			<to uri="velocity:velocity/ErrorHttp.vm" />

		</onException>


		<!-- applycarrierbillingRefund -->
		<route streamCache="true">
			<from
				uri="jetty:http://{{carrier.refund.host}}:{{carrier.refund.port}}{{carrier.refund.url}}" />


		<doTry>
				<setHeader headerName="requestId">
					<jsonpath>$.requestId</jsonpath>
				</setHeader>
				<setHeader headerName="bangoTransactionId">
					<jsonpath>$.bangoTransactionId</jsonpath>
				</setHeader>
				<setHeader headerName="merchantTransactionId">
					<jsonpath>$.merchantTransactionId</jsonpath>
				</setHeader>
				<setHeader headerName="paymentProviderTransactionId">
					<jsonpath>$.paymentProviderTransactionId</jsonpath>
				</setHeader>
				<setHeader headerName="userId">
					<jsonpath>$.userId</jsonpath>
				</setHeader>
				<setHeader headerName="amount">
					<jsonpath>$.amount</jsonpath>
				</setHeader>
				<setHeader headerName="currency">
					<jsonpath>$.currency</jsonpath>
				</setHeader>
				<doCatch>
					<exception>org.apache.camel.ExpressionEvaluationException
					</exception>
					<setHeader headerName="Exchange.HTTP_RESPONSE_CODE">
						<simple>422</simple>
					</setHeader>
					<to uri="velocity:velocity/422.vm" />
					<setHeader headerName="Content-Type">
						<constant>application/json</constant>
					</setHeader>
					<stop />
				</doCatch>
			</doTry>
			<choice>
				<when>
					<simple>
					${headers.requestId} == "" || 
					${headers.bangoTransactionId} == "" || 
					${headers.merchantTransactionId} == "" || 
					${headers.paymentProviderTransactionId} == "" ||
					${headers.userId} == "" || 
					${headers.amount} == "" || 
					${headers.currency} == ""
					</simple>
					<throwException
						exceptionType="cl.wom.exception.services.ServiceError"
						message="400" />
				</when>
			</choice>


			<bean ref="sqlFormatterProcessor" method="sqlParserCarrierRefund"></bean>
			
			<log message="CONSUMO DEL SERVICIO: ${body}"></log>
			
<!-- 			<!-- CONSUME SERVICIO --> -->
<!-- 			<to uri="velocity:velocity/soap-request.vm" /> -->
<!-- 			<to uri="cxf:http://10.120.147.126:80/esb/3GBSCS/Services/PSBookingRequestWrite?dataFormat=MESSAGE"></to> -->
<!-- 				<setHeader headerName="occId"><xpath>/soapenv:Envelope/soapenv:Body/*/*[local-name() = 'occId']/text()</xpath></setHeader> -->
<!-- 			<setHeader headerName="Content-Type"> -->
<!-- 				<constant>application/json</constant> -->
<!-- 			</setHeader> -->
<!-- 			<log message="occId: ${headers.occId}"></log> -->
			
		</route>
	</camelContext>
</beans>
